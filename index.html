<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>全稳态时钟</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Sora:wght@300;400;600;700&family=Space+Grotesk:wght@400;600&display=swap');

    :root {
      --bg-1: #0f1a1f;
      --bg-2: #162f3b;
      --bg-3: #1b3f4d;
      --accent-1: #f6c453;
      --accent-2: #ff6a5c;
      --accent-3: #6ae3ff;
      --text-1: #e9f3f7;
      --text-2: rgba(233, 243, 247, 0.7);
      --panel: rgba(20, 30, 36, 0.78);
      --stroke: rgba(233, 243, 247, 0.2);
      --shadow: 0 30px 80px rgba(7, 12, 16, 0.55);
      --ring: rgba(233, 243, 247, 0.2);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 32px 20px 48px;
      font-family: "Sora", "Space Grotesk", sans-serif;
      color: var(--text-1);
      background: radial-gradient(circle at 20% 20%, rgba(120, 195, 255, 0.12), transparent 50%),
        radial-gradient(circle at 80% 0%, rgba(255, 170, 120, 0.1), transparent 45%),
        linear-gradient(135deg, var(--bg-1), var(--bg-2), var(--bg-3));
      overflow-x: hidden;
    }

    body::before {
      content: "";
      position: fixed;
      inset: -30% 0 0 0;
      background: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.06), transparent 55%),
        repeating-linear-gradient(120deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0.02) 1px, transparent 1px, transparent 6px);
      opacity: 0.7;
      pointer-events: none;
      animation: drift 16s ease-in-out infinite alternate;
    }

    @keyframes drift {
      from {
        transform: translateY(0);
      }
      to {
        transform: translateY(-40px);
      }
    }

    .layout {
      width: min(1100px, 100%);
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 24px;
      align-items: center;
    }

    .title {
      font-size: clamp(28px, 3.4vw, 44px);
      font-weight: 700;
      letter-spacing: 0.02em;
      margin: 0 0 8px 0;
    }

    .subtitle {
      font-size: 15px;
      color: var(--text-2);
      margin: 0 0 24px 0;
      line-height: 1.6;
    }

    .clock-shell {
      position: relative;
      aspect-ratio: 1 / 1;
      width: min(420px, 85vw);
      justify-self: center;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 25%, rgba(255, 255, 255, 0.1), transparent 55%),
        radial-gradient(circle at 70% 70%, rgba(106, 227, 255, 0.2), transparent 50%),
        rgba(12, 18, 22, 0.9);
      box-shadow: var(--shadow);
      border: 1px solid rgba(233, 243, 247, 0.15);
      display: grid;
      place-items: center;
      animation: pop 1.2s ease-out both;
      overflow: visible;
    }

    .clock-shell::before {
      content: "";
      position: absolute;
      inset: -6%;
      border-radius: 50%;
      background:
        conic-gradient(from 180deg, rgba(246, 196, 83, 0.12), rgba(96, 178, 255, 0.12), rgba(246, 196, 83, 0.12)),
        radial-gradient(circle at 50% 55%, rgba(255, 255, 255, 0.08), transparent 60%);
      border: 1px solid rgba(233, 243, 247, 0.12);
      box-shadow: inset 0 0 30px rgba(255, 255, 255, 0.04), 0 25px 50px rgba(0, 0, 0, 0.45);
      z-index: 0;
    }

    .clock-shell::after {
      content: "";
      position: absolute;
      inset: 6%;
      border-radius: 50%;
      background:
        radial-gradient(circle at 28% 22%, rgba(255, 255, 255, 0.2), transparent 45%),
        radial-gradient(circle at 70% 75%, rgba(106, 227, 255, 0.12), transparent 55%);
      opacity: 0.6;
      mix-blend-mode: screen;
      pointer-events: none;
      z-index: 3;
    }

    @keyframes pop {
      from {
        transform: scale(0.95);
        opacity: 0;
      }
      to {
        transform: scale(1);
        opacity: 1;
      }
    }

    .clock-face {
      position: relative;
      width: 84%;
      height: 84%;
      border-radius: 50%;
      background: conic-gradient(
          from 180deg,
          rgba(246, 196, 83, 0.5) 0deg,
          rgba(246, 196, 83, 0.5) 180deg,
          rgba(96, 178, 255, 0.28) 180deg,
          rgba(96, 178, 255, 0.28) 360deg
        ),
        radial-gradient(circle at 50% 40%, rgba(255, 255, 255, 0.12) 0%, rgba(10, 15, 18, 0.75) 55%, rgba(6, 10, 13, 0.95) 100%);
      border: 1px solid rgba(233, 243, 247, 0.18);
      box-shadow: inset 0 0 30px rgba(0, 0, 0, 0.5);
      overflow: hidden;
      z-index: 1;
    }

    .clock-face::before {
      content: "";
      position: absolute;
      inset: 3%;
      border-radius: 50%;
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: inset 0 0 25px rgba(0, 0, 0, 0.45);
      pointer-events: none;
    }

    .clock-face::after {
      content: "";
      position: absolute;
      inset: 10%;
      border-radius: 50%;
      background: radial-gradient(circle at 38% 35%, rgba(255, 255, 255, 0.12), transparent 55%);
      opacity: 0.7;
      pointer-events: none;
    }

    .ticks {
      position: absolute;
      inset: 0;
      border-radius: 50%;
      background:
        repeating-conic-gradient(
          from -90deg,
          rgba(255, 255, 255, 0.35) 0deg 1deg,
          transparent 1deg 6deg
        ),
        repeating-conic-gradient(
          from -90deg,
          rgba(255, 255, 255, 0.75) 0deg 2deg,
          transparent 2deg 30deg
        );
      mask: radial-gradient(circle, transparent 60%, black 62%);
      opacity: 0.55;
    }

    .numbers {
      position: absolute;
      inset: 0;
      font-family: "Space Grotesk", sans-serif;
      font-weight: 600;
      color: rgba(233, 243, 247, 0.8);
      letter-spacing: 0.03em;
      --radius: 205%;
      text-shadow: 0 2px 8px rgba(0, 0, 0, 0.55);
      pointer-events: none;
    }

    .number {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%) rotate(calc(var(--i) * 30deg)) translateY(calc(var(--radius) * -1)) rotate(calc(var(--i) * -30deg));
      transform-origin: center;
      font-size: 16px;
    }

    .hand {
      position: absolute;
      left: 50%;
      top: 50%;
      transform-origin: 50% 100%;
      transform: translate(-50%, -100%) rotate(var(--angle));
      border-radius: 999px;
      box-shadow: 0 0 12px rgba(0, 0, 0, 0.35);
    }

    .hand.hour {
      width: 8px;
      height: 32%;
      background: linear-gradient(180deg, #ffffff, #9acde1);
    }

    .hand.minute {
      width: 5px;
      height: 44%;
      background: linear-gradient(180deg, #f6c453, #ff9270);
    }

    .hand.second {
      width: 2px;
      height: 48%;
      background: linear-gradient(180deg, #ff6a5c, #ffd1a1);
    }

    .hand-cap {
      position: absolute;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: var(--accent-3);
      box-shadow: 0 0 16px rgba(106, 227, 255, 0.6);
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
    }

    .info-panel {
      background: var(--panel);
      border: 1px solid var(--stroke);
      border-radius: 18px;
      padding: 22px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
    }

    .label {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.2em;
      color: var(--text-2);
      margin-bottom: 6px;
    }

    .value {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 14px;
    }

    .sub-value {
      font-size: 14px;
      color: var(--text-2);
      margin-bottom: 12px;
    }

    .grid {
      display: grid;
      gap: 12px;
    }

    .inputs {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
      margin-top: 12px;
    }

    input {
      width: 100%;
      background: rgba(255, 255, 255, 0.06);
      border: 1px solid rgba(233, 243, 247, 0.2);
      color: var(--text-1);
      padding: 10px 12px;
      border-radius: 10px;
      font-size: 14px;
    }

    button {
      background: linear-gradient(135deg, #f6c453, #ff6a5c);
      border: none;
      color: #1a1b1f;
      font-weight: 600;
      padding: 10px 14px;
      border-radius: 10px;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(246, 196, 83, 0.35);
    }

    .status {
      font-size: 13px;
      color: var(--text-2);
      min-height: 18px;
    }

    .scale {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 12px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      border: 1px solid rgba(233, 243, 247, 0.12);
    }

    .scale-bar {
      flex: 1;
      height: 6px;
      border-radius: 99px;
      background: linear-gradient(90deg, rgba(106, 227, 255, 0.4), rgba(246, 196, 83, 0.9), rgba(255, 106, 92, 0.6));
      position: relative;
      overflow: hidden;
    }

    .scale-indicator {
      position: absolute;
      top: 50%;
      transform: translate(-50%, -50%);
      width: 14px;
      height: 14px;
      background: var(--accent-3);
      border-radius: 50%;
      box-shadow: 0 0 12px rgba(106, 227, 255, 0.6);
    }

    .footnote {
      font-size: 12px;
      color: var(--text-2);
      line-height: 1.6;
    }
  </style>
</head>
<body>
  <div class="layout">
    <div>
      <h1 class="title">全稳态时钟</h1>
      <p class="subtitle">
        将季节造成的昼夜长短差异均匀分摊到每一秒，使太阳永远在稳态时间的 06:00 升起、18:00 落下。
      </p>
      <div class="info-panel">
        <div class="label">当前全稳态时间</div>
        <div class="value" id="steadyTime">--:--:--</div>
        <div class="grid">
          <div>
            <div class="label">当前时段</div>
            <div class="sub-value" id="segment">--</div>
          </div>
          <div>
            <div class="label">稳态秒倍率</div>
            <div class="value" id="ratio">--</div>
            <div class="sub-value" id="ratioHint">1 稳态秒 = -- 标准秒</div>
          </div>
          <div>
            <div class="label">今日日出 / 日落</div>
            <div class="sub-value" id="sunTimes">--</div>
          </div>
          <div>
            <div class="label">昼长 / 夜长</div>
            <div class="sub-value" id="dayNight">--</div>
          </div>
          <div>
            <div class="label">秒长刻度</div>
            <div class="scale">
              <div class="scale-bar">
                <div class="scale-indicator" id="scaleDot"></div>
              </div>
              <div class="sub-value" id="scaleLabel">--</div>
            </div>
          </div>
        </div>
        <div class="inputs">
          <input id="lat" type="number" step="0.0001" placeholder="纬度 (例如 40.7128)" />
          <input id="lon" type="number" step="0.0001" placeholder="经度 (例如 -74.0060)" />
          <button id="locate">使用设备定位</button>
        </div>
        <div class="status" id="status"></div>
      </div>
      <p class="footnote">
        标准时间以本地时区为基准，稳态时间根据日出日落线性缩放。若未授权定位，可手动输入经纬度。
      </p>
    </div>

    <div class="clock-shell">
      <div class="clock-face" aria-hidden="true">
        <div class="ticks"></div>
        <div class="numbers" id="numbers"></div>
        <div class="hand hour" id="hourHand"></div>
        <div class="hand minute" id="minuteHand"></div>
        <div class="hand second" id="secondHand"></div>
        <div class="hand-cap"></div>
      </div>
    </div>
  </div>

  <script>
    const latInput = document.getElementById("lat");
    const lonInput = document.getElementById("lon");
    const locateBtn = document.getElementById("locate");
    const statusEl = document.getElementById("status");

    const steadyTimeEl = document.getElementById("steadyTime");
    const segmentEl = document.getElementById("segment");
    const ratioEl = document.getElementById("ratio");
    const ratioHintEl = document.getElementById("ratioHint");
    const sunTimesEl = document.getElementById("sunTimes");
    const dayNightEl = document.getElementById("dayNight");
    const scaleDot = document.getElementById("scaleDot");
    const scaleLabel = document.getElementById("scaleLabel");

    const hourHand = document.getElementById("hourHand");
    const minuteHand = document.getElementById("minuteHand");
    const secondHand = document.getElementById("secondHand");

    const STORAGE_KEY = "steadyClockLocation";
    const DEFAULT_LOCATION = { lat: 40.7128, lon: -74.0060 };

    const deg2rad = (deg) => (deg * Math.PI) / 180;
    const rad2deg = (rad) => (rad * 180) / Math.PI;

    function pad(num) {
      return String(Math.floor(num)).padStart(2, "0");
    }

    function formatTimeFromSeconds(totalSeconds) {
      const sec = totalSeconds % 60;
      const min = Math.floor(totalSeconds / 60) % 60;
      const hour = Math.floor(totalSeconds / 3600) % 24;
      return `${pad(hour)}:${pad(min)}:${pad(sec)}`;
    }

    function formatDuration(seconds) {
      const totalMinutes = Math.round(seconds / 60);
      const h = Math.floor(totalMinutes / 60);
      const m = totalMinutes % 60;
      return `${h}h ${pad(m)}m`;
    }

    function dayOfYear(date) {
      const start = new Date(date.getFullYear(), 0, 0);
      const diff = date - start;
      return Math.floor(diff / 86400000);
    }

    function getSunTimes(date, lat, lon) {
      const latClamped = Math.max(-89.999, Math.min(89.999, lat));
      const lonClamped = Math.max(-180, Math.min(180, lon));

      const day = new Date(date.getFullYear(), date.getMonth(), date.getDate());
      const N = dayOfYear(day);
      const gamma = (2 * Math.PI / 365) * (N - 1);

      const eqtime = 229.18 * (
        0.000075 +
        0.001868 * Math.cos(gamma) -
        0.032077 * Math.sin(gamma) -
        0.014615 * Math.cos(2 * gamma) -
        0.040849 * Math.sin(2 * gamma)
      );

      const decl =
        0.006918 -
        0.399912 * Math.cos(gamma) +
        0.070257 * Math.sin(gamma) -
        0.006758 * Math.cos(2 * gamma) +
        0.000907 * Math.sin(2 * gamma) -
        0.002697 * Math.cos(3 * gamma) +
        0.00148 * Math.sin(3 * gamma);

      const zenith = 90.833;
      const latRad = deg2rad(latClamped);
      const cosH =
        (Math.cos(deg2rad(zenith)) - Math.sin(latRad) * Math.sin(decl)) /
        (Math.cos(latRad) * Math.cos(decl));

      if (cosH > 1) {
        return { status: "polar-night" };
      }
      if (cosH < -1) {
        return { status: "polar-day" };
      }

      const H = Math.acos(cosH);
      const Hdeg = rad2deg(H);
      const tzOffset = -day.getTimezoneOffset() / 60;
      const solarNoon = 720 - 4 * lonClamped - eqtime + tzOffset * 60;

      const sunriseMinutes = solarNoon - Hdeg * 4;
      const sunsetMinutes = solarNoon + Hdeg * 4;

      const midnight = new Date(day.getFullYear(), day.getMonth(), day.getDate());
      const sunrise = new Date(midnight.getTime() + sunriseMinutes * 60000);
      const sunset = new Date(midnight.getTime() + sunsetMinutes * 60000);

      return { status: "ok", sunrise, sunset };
    }

    function safeLocation() {
      const lat = parseFloat(latInput.value);
      const lon = parseFloat(lonInput.value);

      if (!Number.isFinite(lat) || !Number.isFinite(lon)) {
        statusEl.textContent = "请输入有效经纬度，当前使用默认位置。";
        return { ...DEFAULT_LOCATION, fallback: true };
      }

      statusEl.textContent = "";
      return { lat, lon, fallback: false };
    }

    function saveLocation(lat, lon) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify({ lat, lon }));
    }

    function loadLocation() {
      const saved = localStorage.getItem(STORAGE_KEY);
      if (saved) {
        try {
          const { lat, lon } = JSON.parse(saved);
          if (Number.isFinite(lat) && Number.isFinite(lon)) {
            latInput.value = lat.toFixed(4);
            lonInput.value = lon.toFixed(4);
            return;
          }
        } catch (err) {
          // ignore
        }
      }
      latInput.value = DEFAULT_LOCATION.lat.toFixed(4);
      lonInput.value = DEFAULT_LOCATION.lon.toFixed(4);
    }

    function getSteadyTime(now, lat, lon) {
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const yesterday = new Date(today);
      yesterday.setDate(today.getDate() - 1);
      const tomorrow = new Date(today);
      tomorrow.setDate(today.getDate() + 1);

      const sunToday = getSunTimes(today, lat, lon);
      const sunYesterday = getSunTimes(yesterday, lat, lon);
      const sunTomorrow = getSunTimes(tomorrow, lat, lon);

      if (sunToday.status !== "ok" || sunTomorrow.status !== "ok" || sunYesterday.status !== "ok") {
        return {
          valid: false,
          message: "该纬度可能出现极昼或极夜，已暂用标准时间显示。",
          steadySeconds: now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds(),
          ratio: 1,
          segment: "标准时段",
        };
      }

      const sunriseToday = sunToday.sunrise.getTime();
      const sunsetToday = sunToday.sunset.getTime();
      const sunriseTomorrow = sunTomorrow.sunrise.getTime();
      const sunsetYesterday = sunYesterday.sunset.getTime();

      const dayLength = (sunsetToday - sunriseToday) / 1000;
      const nowMs = now.getTime();

      let segment = "昼";
      let ratio = 1;
      let segmentLength = dayLength;
      let steadySeconds = 0;
      let nightLength = 0;

      if (nowMs >= sunriseToday && nowMs < sunsetToday) {
        segment = "昼 (日出至日落)";
        ratio = dayLength / 43200;
        steadySeconds = 6 * 3600 + ((nowMs - sunriseToday) / 1000) * (43200 / dayLength);
        nightLength = (sunriseTomorrow - sunsetToday) / 1000;
      } else if (nowMs < sunriseToday) {
        segment = "夜 (日落至日出)";
        nightLength = (sunriseToday - sunsetYesterday) / 1000;
        ratio = nightLength / 43200;
        steadySeconds =
          (18 * 3600 + ((nowMs - sunsetYesterday) / 1000) * (43200 / nightLength)) % 86400;
      } else {
        segment = "夜 (日落至日出)";
        nightLength = (sunriseTomorrow - sunsetToday) / 1000;
        ratio = nightLength / 43200;
        steadySeconds =
          (18 * 3600 + ((nowMs - sunsetToday) / 1000) * (43200 / nightLength)) % 86400;
      }

      return {
        valid: true,
        steadySeconds,
        ratio,
        segment,
        sunrise: sunToday.sunrise,
        sunset: sunToday.sunset,
        dayLength,
        nightLength,
      };
    }

    function updateHands(steadySeconds) {
      const seconds = steadySeconds % 60;
      const minutes = (steadySeconds / 60) % 60;
      const hours = (steadySeconds / 3600) % 12;

      const secAngle = `${seconds * 6}deg`;
      const minAngle = `${minutes * 6}deg`;
      const hourAngle = `${hours * 30 + minutes * 0.5}deg`;

      secondHand.style.setProperty("--angle", secAngle);
      minuteHand.style.setProperty("--angle", minAngle);
      hourHand.style.setProperty("--angle", hourAngle);
    }

    function updateScale(ratio) {
      const clamped = Math.max(0.6, Math.min(1.4, ratio));
      const pct = ((clamped - 0.6) / (1.4 - 0.6)) * 100;
      scaleDot.style.left = `${pct}%`;
      scaleLabel.textContent = `${ratio.toFixed(4)}x`;
    }

    function updateText(info) {
      steadyTimeEl.textContent = formatTimeFromSeconds(info.steadySeconds);
      segmentEl.textContent = info.segment;

      ratioEl.textContent = `${info.ratio.toFixed(5)} 倍`;
      ratioHintEl.textContent = `1 稳态秒 = ${info.ratio.toFixed(5)} 标准秒`;
      updateScale(info.ratio);

      if (info.valid && info.sunrise && info.sunset) {
        const sunrise = info.sunrise.toLocaleTimeString("zh-CN", { hour: "2-digit", minute: "2-digit" });
        const sunset = info.sunset.toLocaleTimeString("zh-CN", { hour: "2-digit", minute: "2-digit" });
        sunTimesEl.textContent = `${sunrise} / ${sunset}`;
        dayNightEl.textContent = `${formatDuration(info.dayLength)} / ${formatDuration(info.nightLength)}`;
      } else {
        sunTimesEl.textContent = "--";
        dayNightEl.textContent = "--";
      }

      if (!info.valid) {
        statusEl.textContent = info.message;
      }
    }

    function initNumbers() {
      const container = document.getElementById("numbers");
      for (let i = 1; i <= 12; i += 1) {
        const span = document.createElement("span");
        span.className = "number";
        span.style.setProperty("--i", i);
        span.textContent = i;
        container.appendChild(span);
      }
    }

    function boot() {
      loadLocation();
      initNumbers();

      locateBtn.addEventListener("click", () => {
        if (!navigator.geolocation) {
          statusEl.textContent = "当前浏览器不支持定位。";
          return;
        }

        statusEl.textContent = "正在请求定位权限...";
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            const { latitude, longitude } = pos.coords;
            latInput.value = latitude.toFixed(4);
            lonInput.value = longitude.toFixed(4);
            saveLocation(latitude, longitude);
            statusEl.textContent = "已更新设备位置。";
          },
          (err) => {
            statusEl.textContent = `定位失败：${err.message}`;
          },
          { enableHighAccuracy: true, timeout: 8000 }
        );
      });

      [latInput, lonInput].forEach((input) => {
        input.addEventListener("change", () => {
          const lat = parseFloat(latInput.value);
          const lon = parseFloat(lonInput.value);
          if (Number.isFinite(lat) && Number.isFinite(lon)) {
            saveLocation(lat, lon);
            statusEl.textContent = "已保存经纬度。";
          }
        });
      });

      let lastTextUpdate = 0;
      function tick(timestamp) {
        const now = new Date();
        const { lat, lon } = safeLocation();
        const info = getSteadyTime(now, lat, lon);

        updateHands(info.steadySeconds);

        if (timestamp - lastTextUpdate > 250) {
          updateText(info);
          lastTextUpdate = timestamp;
        }

        requestAnimationFrame(tick);
      }

      requestAnimationFrame(tick);
    }

    boot();
  </script>
</body>
</html>
